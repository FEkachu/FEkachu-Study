# 📍 자바스크립트의 동작 환경

모든 브라우저는 자바스크립트 코드를 해석하고 실행할 수 있는 엔진을 내장하고 있다. 브라우저 뿐만 아니라 Node.js도 자바스크립트 엔진을 내장하고 있다. 따라서 자바스크립트는 **브라우저와 Node.js 환경**에서 실행할 수 있다.

## 브라우저와 Node.js

- 브라우저 : HTML, CSS, 자바스크립트를 실행하여 웹 페이지를 화면에 렌더링하는 것이 주목적
- Node.js : 서버 개발 환경을 제공하는 것이 주목적

브라우저와 Node.js 모두 ECMAScript를 실행할 수 있지만 그 외에 추가적으로 제공하는 기능은 호환되지 않는다.

예를 들어 브라우저는 HTML 요소를 선택하거나 조작하는 기능들의 집합인 DOM API를 기본적으로 제공하지만, 서버에서는 HTML 요소를 다룰 일이 없기 때문에 Node.js는 DOM API를 제공하지 않는다.

반대로 Node.js에서는 파일을 생성하고 수정하는 File 시스템을 기본으로 제공하지만 브라우저는 이를 지원하지 않는다. 브라우저는 사용자 컴퓨터에서 작동하기 때문에 브라우저를 통해 파일 생성/수정이 가능하다면 사용자 컴퓨터가 악성 코드에 노출되기 쉬워 보안 상의 이유로 금지하는 것이다.

이처럼 브라우저는 클라이언트 사이드 ECMAScript와 Web API를 지원하며, Node.js는 ECMAScript와 Node.js 고유의 API를 지원한다.

## 자바스크립트 실행 환경

그렇다면 자바스크립트는 어떤 환경이 갖춰져야 동작이 가능한 걸까?

![https://blog.kakaocdn.net/dn/bREdmQ/btq3nBEgBmI/00k7kyyWItbCnnCjrUUXvk/img.png](https://blog.kakaocdn.net/dn/bREdmQ/btq3nBEgBmI/00k7kyyWItbCnnCjrUUXvk/img.png)

자바스크립트 코드는 특정한 실행환경이 갖춰져야 동작이 가능하다.

- 자바스크립트 엔진
- Web API / Node API
- callback 큐
- 이벤트 루프

### 자바스크립트 엔진

자바스크립트 엔진은 자바스크립트 코드를 읽고 실행시키는 프로그램이다.

자바스크립트 엔진에는 코드를 실행하는데 필요한 **메모리 힙**과 **콜 스택**이 같이 들어있다. **메모리 힙**에는 non-primitive 타입의 데이터가 저장되고, **콜 스택**에는 함수 호출 시 생성되는 **실행 컨텍스트**가 stack 형태로 쌓이며 저장된다.

실행 컨텍스트에는 함수의 argument, 함수에서 선언한 변수 등 함수가 실행되면서 필요한 정보가 저장되며, 함수 호출 시 생성되고 함수가 종료되면 사라진다. 자바스크립트 엔진은 콜 스택의 제일 위에 있는 함수부터 하나씩 실행한다.

### Web API / Node API

DOM 객체나 setTimeout 같은 함수들은 자바스크립트 언어 자체에서 지원하는 기능이 아닌, 자바스크립트 실행환경에서 제공하는 기능이다. 브라우저 환경에서는 Web API가, node.js 환경에서는 Node API가 제공된다.

### callback Queue

콜백 큐는 콜백 함수들이 실행되기 전에 대기하는 공간이다. 콜백 함수들은 콜백 큐에서 대기하다가 콜 스택이 비게 되면 하나씩 쌓여 실행된다.

### 이벤트 루프

이벤트 루프는 **콜백 큐와 콜 스택을 주시**하며 콜백 큐에서 대기 중인 콜백 함수를 콜 스택이 비었을 때 콜 스택에 쌓아주는 역할을 한다.

---

모든 브라우저는 위 네 가지 구성 요소가 내장되어 있어서 자바스크립트 코드를 실행할 수 있는 것이다. Node.js는 브라우저 밖에서도 자바스크립트 코드를 실행할 수 있도록 위 네 가지 구성요소를 브라우저 밖에 구현해놓은 실행환경이다. 다만, node.js는 브라우저에서 필요한 Web API 대신 Node API 를 제공한다.

## 자바스크립트 동작 방식

자바스크립트 코드가 동작하기 위해 이런 실행 환경을 갖추고 있어야 하는 이유는 자바스크립트가 **single thread에서 동작하는 언어**이기 때문이다. 즉, 하나의 콜 스택만 가지고 있으며 한 번에 한 가지 일만 처리할 수 있다. 그렇지만 자바스크립트가 처리하는 브라우저의 이벤트는 한 번에 한 가지씩만 발생하지 않기 때문에 **single thread로 비동기적으로 발생하는 이벤트를 처리**할 수 있어야 한다.

이를 위해 등장한 것이 **콜백 함수**이다. 자바스크립트에서는 비동기 처리가 필요한 경우 콜백 함수를 받고 그 함수들은 콜백 큐에서 대기한다. 그리고 이벤트 루프가 자바스크립트 코드 내의 모든 동기 함수들의 처리가 끝난 후 콜 스택이 비면 콜백 큐에서 대기 중인 콜백 함수들을 하나씩 콜 스택에 쌓아준다. 이런 방식을 통해 자바스크립트는 싱글 스레드를 이용하여 비동기 이벤트를 처리한다. 이런 일들은 매우 빠르게 일어나기 때문에 여러 비동기적인 이벤트들을 동시에 처리하는 것처럼 보이게 된다.
